# GeoTruth Backend Services - Production Configuration
# =============================================================================
# GeoTruth Backend Services - Production Configuration
# =============================================================================

services:
  # ==========================================================================
  # API Server - FastAPI
  # ==========================================================================
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: "3.12"
    container_name: geotruth-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      - POSTGRES_HOST=geo-db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-geotruth}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Database password required}
      - POSTGRES_DB=${POSTGRES_DB:-geotruth}
      - REDIS_URL=redis://cache:6379/0
      - VALHALLA_URL=http://map-matcher:8002
    env_file:
      - .env
    depends_on:
      geo-db:
        condition: service_healthy
      cache:
        condition: service_healthy
    networks:
      - frontend
      - backend
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/v1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service"

  # ==========================================================================
  # PostGIS Database
  # ==========================================================================
  geo-db:
    image: postgis/postgis:16-3.4
    container_name: geotruth-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-geotruth}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Database password required}
      - POSTGRES_DB=${POSTGRES_DB:-geotruth}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./services/geo-db/init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - backend
    expose:
      - "5432"
    # NOT exposed to host for security - only internal access
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-geotruth} -d ${POSTGRES_DB:-geotruth}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Redis Cache
  # ==========================================================================
  cache:
    image: redis:7.4-alpine
    container_name: geotruth-cache
    restart: unless-stopped
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - redis_data:/data
      - ./services/cache/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - backend
    expose:
      - "6379"
    # NOT exposed to host for security - only internal access
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ==========================================================================
  # Valhalla Map Matching
  # ==========================================================================
  map-matcher:
    image: ghcr.io/gis-ops/docker-valhalla/valhalla:latest
    container_name: geotruth-valhalla
    restart: unless-stopped
    environment:
      - tile_urls=https://download.geofabrik.de/north-america/us/california-latest.osm.pbf
      - serve_tiles=True
      - build_elevation=False
      - build_admins=True
      - build_time_zones=True
    volumes:
      - valhalla_tiles:/custom_files
    networks:
      - backend
    expose:
      - "8002"
    # NOT exposed to host for security - only internal access
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/status" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s # Valhalla takes time to build tiles
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: true # No external access to backend network

volumes:
  postgres_data:
  redis_data:
  valhalla_tiles:
